<div class="eqLogic eqLogic-widget jellyfinWidget" style="width: 350px; height: 385px; border: 1px solid #widget_border_color#; border-radius:#border-radius#; background-color: #202020; color: #fff; overflow: hidden; position: relative; display: flex; flex-direction: column;" data-eqLogic_id="#id#" data-eqLogic_uid="#uid#" data-version="#version#">

    <div class="top-container" style="position: relative; flex-grow: 1; overflow: hidden;">
        
        <div class="view-info" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; transition: transform 0.3s ease;">
            <div class="background-blur" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.5; background-size: cover; background-position: center; filter: blur(8px);"></div>
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 1;"></div>

            <div class="widget-name" style="position: absolute; top: 0; left: 0; width: 100%; padding: 5px; text-align: center; z-index: 10; text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">
                <a href="#eqLink#" style="color: #fff; text-decoration: none; font-weight: bold; font-size: 1.1em; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    #name_display#
                </a>
            </div>

            <div style="position: relative; z-index: 2; padding: 15px; padding-top: 35px; display: flex; align-items: center; height: 100%; box-sizing: border-box;">
                
                <div class="album-cover" style="width: 100px; height: auto; min-height: 100px; flex-shrink: 0; border-radius: 6px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.6); background-color: #333; display: flex; align-items: center; justify-content: center;">
                    <img class="cover-img" src="" style="width: 100%; height: auto; display: block; display: none;">
                    <i class="fas fa-music no-cover-icon" style="font-size: 40px; color: #555;"></i>
                </div>

                <div style="flex-grow: 1; margin-left: 15px; overflow: hidden; display: flex; flex-direction: column; justify-content: center;">
                    <span class="cmd cmd-widget widget-title" data-cmd_id="#title_id#" style="font-weight: bold; font-size: 16px; color: #fff; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; margin-bottom: 5px; text-shadow: 0 1px 3px rgba(0,0,0,0.8); line-height: 1.2;">#title#</span>
                    <span class="cmd cmd-widget widget-status" data-cmd_id="#status_id#" style="font-size: 12px; color: #ddd; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 1px 2px rgba(0,0,0,0.8);">#status#</span>
                    <span class="cmd cmd-widget widget-mediatype" data-cmd_id="#media_type_id#" style="font-size: 10px; color: #ccc; margin-top: 2px; text-shadow: 0 1px 2px rgba(0,0,0,0.8);">#media_type#</span>
                </div>
            </div>
        </div>

        <div class="view-shortcuts" style="width: 100%; height: 100%; position: absolute; top: 0; left: 100%; background-color: #222; z-index: 20; transition: left 0.3s ease; display: flex; flex-direction: column;">
            
            <div style="padding: 8px 10px; background: #1a1a1a; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                <span style="font-size: 11px; color: #ccc; text-transform: uppercase; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 280px;" title="Favoris pour #name_display#">
                    <i class="fas fa-heart" style="color:#ff4757; margin-right: 4px;"></i> Mes Favoris <span style="color:#666;">-</span> <span style="color:#fff;">#name_display#</span>
                </span>
                <i class="fas fa-times close-shortcuts-btn cursor" style="color: #888; font-size: 14px; margin-left: 5px;" title="Fermer"></i>
            </div>
            
            <div class="shortcuts-scroll-area" style="flex-grow: 1; overflow-y: auto; padding: 10px;">
                <div class="shortcuts-grid">
                    #shortcuts_html#
                </div>
                <div class="no-shortcuts" style="display:none; text-align: center; padding-top: 40px; color: #666; font-size: 12px;">
                    <i class="fas fa-plus-circle cursor open-lib-trigger" style="font-size: 30px; margin-bottom: 10px; transition: all 0.2s;"></i><br>
                    Aucun favori.<br>Cliquez sur le + pour en ajouter.
                </div>
            </div>
        </div>

    </div>

    <div style="background-color: #2b2b2b; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; border-top: 1px solid #333; z-index: 30; flex-shrink: 0;">
        <div style="margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; font-size: 11px; color: #aaa; margin-bottom: 5px; font-family: monospace;">
                <span class="cmd cmd-widget time-current" data-cmd_id="#position_id#" style="font-size: 11px;">#position#</span>
                <span class="time-remaining" style="font-size: 11px;">--:--</span>
            </div>
            <div class="progress-area" style="width: 100%; height: 12px; display: flex; align-items: center; cursor: pointer; position: relative; z-index: 5;">
                <div class="seek-tooltip" style="position: absolute; top: -25px; background: #333; color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; pointer-events: none; opacity: 0; transition: opacity 0.1s; transform: translateX(-50%); white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.5);">00:00:00</div>
                <div style="width: 100%; height: 4px; background-color: #444; border-radius: 2px; overflow: visible; pointer-events: none;">
                    <div class="progress-bar" style="width: 0%; height: 100%; background-color: #1DB954; border-radius: 2px; position: relative; transition: width 0.1s linear;">
                         <div style="position: absolute; right: -4px; top: -3px; width: 10px; height: 10px; background: #fff; border-radius: 50%; opacity: 0; transition: opacity 0.2s;" class="progress-handle"></div>
                    </div>
                </div>
            </div>
            <div style="display: flex; justify-content: flex-end; font-size: 11px; color: #aaa; margin-top: 2px; font-family: monospace;">
                <span class="cmd cmd-widget time-total" data-cmd_id="#duration_id#" style="font-weight: bold; font-size: 11px;">#duration#</span>
            </div>
        </div>

        <div style="display: flex; align-items: center; z-index: 6; padding-bottom: 5px;">
            <div style="flex-grow: 1; display: flex; justify-content: center; align-items: center; gap: 12px;">
                <a class="btn btn-sm action-btn cmd" onclick="jeedom.cmd.execute({id: '#prev_id#'});"><i class="fas fa-step-backward"></i></a>
                <a class="btn btn-sm action-btn cmd play-pause-btn" onclick="jeedom.cmd.execute({id: '#play_pause_id#'});" 
                   style="width: 50px; height: 50px; border-radius: 50%; background: #fff; color: #2b2b2b; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.5); padding: 0;">
                    <i class="fas fa-play" style="font-size: 20px; margin-left: 3px;"></i>
                </a>
                <a class="btn btn-sm action-btn cmd" onclick="jeedom.cmd.execute({id: '#stop_id#'});"><i class="fas fa-stop"></i></a>
                <a class="btn btn-sm action-btn cmd" onclick="jeedom.cmd.execute({id: '#next_id#'});"><i class="fas fa-step-forward"></i></a>
            </div>
            
            <div style="display: flex; align-items: center; gap: 10px; margin-right: 5px;">
                <i class="fas fa-heart heart-btn toggle-shortcuts-btn" title="Mes favoris"></i>
                <div style="position: relative; z-index: 101;">
                    <img class="logo-jellyfin-img" src="plugins/jellyfin/core/img/logo_jellyfin.png" title="Ouvrir la bibliothèque">
                </div>
            </div>
        </div>
    </div>

    <script>
        var lastSeekTime_#id# = 0;

        function timeToSeconds_#id#(str) {
            if (!str) return 0;
            str = String(str).replace(/<[^>]*>?/gm, '').trim(); 
            var p = str.split(':'), s = 0, m = 1;
            while (p.length > 0) { s += m * parseInt(p.pop(), 10); m *= 60; }
            return s;
        }

        function secondsToTime_#id#(sec_num) {
            var hours = Math.floor(sec_num / 3600);
            var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
            var seconds = Math.floor(sec_num - (hours * 3600) - (minutes * 60));
            if (hours < 10) hours = "0"+hours;
            if (minutes < 10) minutes = "0"+minutes;
            if (seconds < 10) seconds = "0"+seconds;
            return hours+':'+minutes+':'+seconds;
        }

        var $progressArea_#id# = $('.eqLogic[data-eqLogic_id=#id#] .progress-area');
        $progressArea_#id#.off('mousemove mouseleave click');

        $progressArea_#id#.on('mousemove', function(e) {
            var totalStr = $('.eqLogic[data-eqLogic_id=#id#] .time-total').text();
            var totalSec = timeToSeconds_#id#(totalStr);
            if (totalSec <= 0) return;
            var parentOffset = $(this).offset(); 
            var relX = e.pageX - parentOffset.left;
            var pct = relX / $(this).width();
            if (pct < 0) pct = 0; if (pct > 1) pct = 1;
            var seekTimeStr = secondsToTime_#id#(Math.floor(pct * totalSec));
            var tooltip = $(this).find('.seek-tooltip');
            tooltip.text(seekTimeStr).css('left', relX + 'px').css('opacity', 1);
            $(this).find('.progress-handle').css('opacity', 1);
        });

        $progressArea_#id#.on('mouseleave', function() {
            $(this).find('.seek-tooltip').css('opacity', 0);
            $(this).find('.progress-handle').css('opacity', 0);
        });

        $progressArea_#id#.on('click', function(e) {
            var totalStr = $('.eqLogic[data-eqLogic_id=#id#] .time-total').text();
            var totalSec = timeToSeconds_#id#(totalStr);
            if (totalSec <= 0) return;
            var relX = e.pageX - $(this).offset().left;
            var pct = relX / $(this).width();
            if (pct < 0) pct = 0; if (pct > 1) pct = 1;
            var seekTimeSec = Math.floor(pct * totalSec);
            var cmdId = '#set_position_id#';
            if (cmdId != '' && cmdId.indexOf('set_position_id') === -1) {
                lastSeekTime_#id# = Date.now();
                jeedom.cmd.execute({ id: cmdId, value: { slider: seekTimeSec } });
                $('.eqLogic[data-eqLogic_id=#id#] .progress-bar').css('width', (pct * 100) + '%');
                $('.eqLogic[data-eqLogic_id=#id#] .time-current').text(secondsToTime_#id#(seekTimeSec));
            }
        });

        function refreshProgressBar_#id#() {
            var currentSec = timeToSeconds_#id#($('.eqLogic[data-eqLogic_id=#id#] .time-current').text());
            var totalSec = timeToSeconds_#id#($('.eqLogic[data-eqLogic_id=#id#] .time-total').text());
            if (totalSec > 0) {
                var pct = (currentSec / totalSec) * 100;
                $('.eqLogic[data-eqLogic_id=#id#] .progress-bar').css('width', pct + '%');
                var remSec = totalSec - currentSec;
                if (remSec < 0) remSec = 0;
                $('.eqLogic[data-eqLogic_id=#id#] .time-remaining').text("-" + secondsToTime_#id#(remSec));
            } else {
                $('.eqLogic[data-eqLogic_id=#id#] .progress-bar').css('width', '0%');
            }
        }

        function refreshCover_#id#(htmlContent) {
            var src = '';
            if (htmlContent && htmlContent.indexOf('<img') !== -1) {
                var match = htmlContent.match(/src=["']([^"']+)["']/);
                if (match && match[1]) src = match[1];
            } else if (htmlContent && htmlContent.indexOf('http') !== -1) {
                src = htmlContent;
            }

            if (src) {
                $('.eqLogic[data-eqLogic_id=#id#] .cover-img').attr('src', src).show();
                $('.eqLogic[data-eqLogic_id=#id#] .no-cover-icon').hide();
                $('.eqLogic[data-eqLogic_id=#id#] .background-blur').css('background-image', 'url(' + src + ')');
            } else {
                $('.eqLogic[data-eqLogic_id=#id#] .cover-img').hide();
                $('.eqLogic[data-eqLogic_id=#id#] .no-cover-icon').show();
                $('.eqLogic[data-eqLogic_id=#id#] .background-blur').css('background-image', 'none');
            }
        }

        function refreshStatus_#id#() {
            var status = $('.eqLogic[data-eqLogic_id=#id#] .widget-status').text().trim().toLowerCase();
            var icon = $('.eqLogic[data-eqLogic_id=#id#] .play-pause-btn i');
            var bar = $('.eqLogic[data-eqLogic_id=#id#] .progress-bar');
            if (status == 'playing' || status == 'lecture') {
                icon.removeClass('fa-play').addClass('fa-pause').css('margin-left', '0');
                bar.css('background-color', '#1DB954');
            } else {
                icon.removeClass('fa-pause').addClass('fa-play').css('margin-left', '3px');
                bar.css('background-color', '#888');
            }
        }

        var updateJellyfinWidget_#id# = function(_options) {
            if (_options.cmd_id == '#position_id#' && Date.now() - lastSeekTime_#id# < 4000) return;
            var cmd = $('.eqLogic[data-eqLogic_id=#id#] .cmd[data-cmd_id="' + _options.cmd_id + '"]');
            cmd.attr('title','Date de valeur : '+_options.valueDate+'<br/>Collecte : '+_options.collectDate+'<br/>Valeur : '+_options.display_value);
            cmd.html(_options.display_value);
            if(_options.display_value != '') cmd.show(); else cmd.hide();

            if (_options.cmd_id == '#position_id#' || _options.cmd_id == '#duration_id#') refreshProgressBar_#id#();
            if (_options.cmd_id == '#status_id#') refreshStatus_#id#();
            if (_options.cmd_id == '#cover_id#') refreshCover_#id#(_options.display_value);
        }

        if ('#position_id#' != '') jeedom.cmd.update['#position_id#'] = updateJellyfinWidget_#id#;
        if ('#duration_id#' != '') jeedom.cmd.update['#duration_id#'] = updateJellyfinWidget_#id#;
        if ('#status_id#'   != '') jeedom.cmd.update['#status_id#']   = updateJellyfinWidget_#id#;
        if ('#title_id#'    != '') jeedom.cmd.update['#title_id#']    = updateJellyfinWidget_#id#;
        if ('#media_type_id#' != '') jeedom.cmd.update['#media_type_id#'] = updateJellyfinWidget_#id#;
        if ('#cover_id#'    != '') jeedom.cmd.update['#cover_id#']    = updateJellyfinWidget_#id#;

        if('#cover#' != '') refreshCover_#id#('#cover#');
        refreshStatus_#id#();
        refreshProgressBar_#id#();

        if ($('.eqLogic[data-eqLogic_id=#id#] .shortcuts-grid').children().length == 0) {
            $('.eqLogic[data-eqLogic_id=#id#] .no-shortcuts').show();
        }

        $('.eqLogic[data-eqLogic_id=#id#] .logo-jellyfin-img, .eqLogic[data-eqLogic_id=#id#] .open-lib-trigger').off('click').on('click', function() {
            var eqName = '#name_display#'.replace(/'/g, "\\'");
            if (typeof JellyfinBrowser !== 'undefined') {
                JellyfinBrowser.open('#id#', eqName);
            } else {
                $.getScript('plugins/jellyfin/desktop/js/jellyfin.js').done(function(){
                    JellyfinBrowser.open('#id#', eqName);
                });
            }
        });
        
        $('.eqLogic[data-eqLogic_id=#id#] .toggle-shortcuts-btn').off('click').on('click', function() {
            var viewShortcuts = $('.eqLogic[data-eqLogic_id=#id#] .view-shortcuts');
            var btn = $(this);
            if (btn.hasClass('active')) {
                viewShortcuts.css('left', '100%'); 
                btn.removeClass('active');
            } else {
                viewShortcuts.css('left', '0');
                btn.addClass('active');
            }
        });

        $('.eqLogic[data-eqLogic_id=#id#] .close-shortcuts-btn').off('click').on('click', function() {
            $('.eqLogic[data-eqLogic_id=#id#] .toggle-shortcuts-btn').trigger('click');
        });

        // MODIFICATION ICI POUR LE RECOMPTAGE
        $('.eqLogic[data-eqLogic_id=#id#] .delete-shortcut-btn').off('click').on('click', function(e) {
            e.stopPropagation();
            var btn = $(this);
            var cmdId = btn.data('cmd_id');
            var parentCard = btn.closest('.shortcut-item');

            bootbox.confirm("Voulez-vous supprimer ce favori ?", function(result) {
                if (result) {
                    $.ajax({
                        type: 'POST',
                        url: 'plugins/jellyfin/core/ajax/jellyfin.ajax.php',
                        data: {
                            action: 'remove_command',
                            cmdId: cmdId
                        },
                        dataType: 'json',
                        success: function (data) {
                            if (data.state != 'ok') {
                                // Error
                            } else {
                                parentCard.fadeOut(300, function(){ 
                                    $(this).remove(); 
                                    // Vérification s'il reste des éléments
                                    var remainingItems = $('.eqLogic[data-eqLogic_id=#id#] .shortcuts-grid .shortcut-item').length;
                                    if (remainingItems === 0) {
                                        $('.eqLogic[data-eqLogic_id=#id#] .no-shortcuts').fadeIn(200);
                                    }
                                });
                            }
                        }
                    });
                }
            });
        });
    </script>

    <style>
        .shortcuts-scroll-area::-webkit-scrollbar { width: 6px; }
        .shortcuts-scroll-area::-webkit-scrollbar-track { background: #1a1a1a; }
        .shortcuts-scroll-area::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        .shortcuts-scroll-area::-webkit-scrollbar-thumb:hover { background: #1DB954; }

        .jellyfinWidget .action-btn { color: #ccc; background: transparent; border: none; font-size: 20px; transition: all 0.2s; cursor: pointer; }
        .jellyfinWidget .action-btn:hover { color: #1DB954; transform: scale(1.1); }
        .jellyfinWidget .play-pause-btn:hover { color: #000 !important; transform: scale(1.1); box-shadow: 0 4px 12px rgba(255,255,255,0.4); }
        .jellyfinWidget .widget-name a:hover { text-decoration: none !important; color: #1DB954 !important; text-shadow: 0 0 5px rgba(29, 185, 84, 0.4); }
        .jellyfinWidget .progress-area:hover .progress-bar { background-color: #1ed760 !important; }
        
        .logo-jellyfin-img { height: 40px; cursor: pointer; opacity: 0.5; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; z-index: 101;}
        .logo-jellyfin-img:hover { opacity: 1; transform: scale(1.2); filter: drop-shadow(0 0 8px rgba(29, 185, 84, 0.8)); }

        .heart-btn { color: #666; cursor: pointer; font-size: 18px; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; z-index: 102; }
        .heart-btn:hover, .heart-btn.active { color: #ff4757 !important; transform: scale(1.2); filter: drop-shadow(0 0 5px rgba(255, 71, 87, 0.6)); }

        .open-lib-trigger:hover { color: #1DB954 !important; transform: scale(1.2); }

        .shortcuts-grid { display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-start; }
        .shortcut-item {
            width: 60px;
            height: 90px;
            position: relative;
            border-radius: 4px;
            overflow: hidden;
            background: #333;
            transition: transform 0.2s;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .shortcut-item:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.8);
            border: 1px solid #1DB954;
        }
        .shortcut-item img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            display: block;
        }
        
        .cursor { cursor: pointer; }

        .delete-shortcut-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            color: #ff4757;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            font-size: 14px;
            display: none;
            z-index: 20;
            transition: all 0.2s;
        }
        .delete-shortcut-btn:hover { transform: scale(1.2); color: red; background: black; }
        .shortcut-item:hover .delete-shortcut-btn { display: block; }
    </style>
</div>