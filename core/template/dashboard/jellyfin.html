<div class="eqLogic eqLogic-widget jellyfinWidget" style="width: 350px; height: 340px; border: 1px solid #widget_border_color#; border-radius:#border-radius#; background-color: #202020; color: #fff; overflow: hidden; position: relative; display: flex; flex-direction: column;" data-eqLogic_id="#id#" data-eqLogic_uid="#uid#" data-version="#version#">

    <div class="top-container" style="position: relative; flex-grow: 1; overflow: hidden;">
        
        <div class="view-info" style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; transition: transform 0.3s ease;">
            <div class="background-blur" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.5; background-size: cover; background-position: center; filter: blur(8px);"></div>
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 1;"></div>

            <div class="widget-name" style="position: absolute; top: 0; left: 0; width: 100%; padding: 5px; text-align: center; z-index: 10; text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">
                <a href="#eqLink#" style="color: #fff; text-decoration: none; font-weight: bold; font-size: 1.1em; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: color 0.3s;">
                    #name_display#
                </a>
            </div>

            <div style="position: relative; z-index: 2; padding: 15px; padding-top: 35px; display: flex; align-items: center; height: 100%; box-sizing: border-box;">
                
                <div class="album-cover" style="width: 100px; height: auto; min-height: 100px; flex-shrink: 0; border-radius: 6px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.6); background-color: #333; display: flex; align-items: center; justify-content: center; position: relative;">
                    <img class="cover-img" src="" style="width: 100%; height: auto; display: block; display: none;">
                    <i class="fas fa-music no-cover-icon" style="font-size: 40px; color: #555;"></i>
                </div>

                <div style="flex-grow: 1; margin-left: 15px; overflow: hidden; display: flex; flex-direction: column; justify-content: center;">
                    <span class="cmd cmd-widget widget-title" data-cmd_id="#title_id#" style="font-weight: bold; font-size: 16px; color: #fff; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; text-shadow: 0 1px 3px rgba(0,0,0,0.8); line-height: 1.2;">#title#</span>
                    <span class="cmd cmd-widget widget-status" data-cmd_id="#status_id#" style="font-size: 11px; color: #ddd; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 1px 2px rgba(0,0,0,0.8);">#status#</span>
                    <span class="cmd cmd-widget widget-mediatype" data-cmd_id="#media_type_id#" style="font-size: 10px; color: #aaa; text-shadow: 0 1px 2px rgba(0,0,0,0.8);">#media_type#</span>
                    
                    <div style="margin-top: 8px;">
                        <div class="add-current-fav-btn" style="display: none; align-items: center; gap: 5px; cursor: pointer; color: #fff; width: fit-content; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 10px; transition: all 0.2s;">
                            <i class="fas fa-heart" style="font-size: 12px;"></i>
                            <span class="fav-text-label" style="font-size: 10px; font-weight: bold; text-transform: uppercase;">Favori</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="view-shortcuts" style="width: 100%; height: 100%; position: absolute; top: 0; left: 100%; background-color: #222; z-index: 20; transition: left 0.3s ease; display: flex; flex-direction: column;">
            <div style="padding: 8px 10px; background: #1a1a1a; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
                <span style="font-size: 11px; color: #ccc; text-transform: uppercase; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 280px;">
                    <i class="fas fa-heart" style="color:#ff4757; margin-right: 4px;"></i> <span class="txt-mes-favoris">Mes Favoris</span> <span style="color:#666;">-</span> <span style="color:#fff;">#name_display#</span>
                </span>
                <i class="fas fa-times close-shortcuts-btn cursor" style="color: #888; font-size: 14px; margin-left: 5px;"></i>
            </div>
            
            <div class="shortcuts-scroll-area" style="flex-grow: 1; overflow-y: auto; padding: 10px; position: relative;">
                <div class="shortcuts-grid">#shortcuts_html#</div>
                
                <div class="no-shortcuts" style="display:none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; flex-direction: column; justify-content: center; align-items: center; color: #666; font-size: 12px; z-index: 5;">
                    <i class="fas fa-plus-circle cursor open-lib-trigger" style="font-size: 40px; margin-bottom: 15px; color: #444; transition: all 0.2s;"></i>
                    <div class="txt-aucun-favori" style="text-align: center; line-height: 1.5;"></div>
                </div>
            </div>
        </div>
    </div>

    <div style="background-color: #2b2b2b; padding: 15px; border-top: 1px solid #333; z-index: 30; flex-shrink: 0;">
        <div style="margin-bottom: 10px;">
            <div style="display: flex; justify-content: space-between; font-size: 10px; color: #aaa; margin-bottom: 4px; font-family: monospace;">
                <span class="cmd cmd-widget time-current" data-cmd_id="#position_id#">#position#</span>
                <span class="time-remaining">--:--</span>
            </div>
            <div class="progress-area" style="width: 100%; height: 12px; display: flex; align-items: center; cursor: pointer; position: relative;">
                <div class="seek-tooltip" style="position: absolute; top: -25px; background: #333; color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; opacity: 0; pointer-events: none; transform: translateX(-50%); white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.5);">00:00:00</div>
                <div style="width: 100%; height: 4px; background-color: #444; border-radius: 2px; width: 100%; overflow: visible; position: relative;">
                    <div class="progress-bar" style="width: 0%; height: 100%; background-color: #1DB954; border-radius: 2px; position: relative; transition: width 0.1s linear;">
                         <div style="position: absolute; right: -4px; top: -3px; width: 10px; height: 10px; background: #fff; border-radius: 50%; opacity: 0; transition: opacity 0.2s;" class="progress-handle"></div>
                    </div>
                </div>
            </div>
            <div style="display: flex; justify-content: flex-end; font-size: 10px; color: #aaa; margin-top: 2px; font-family: monospace;">
                <span class="cmd cmd-widget time-total" data-cmd_id="#duration_id#">#duration#</span>
            </div>
        </div>

        <div style="display: flex; align-items: center;">
            <div style="flex-grow: 1; display: flex; justify-content: center; align-items: center; gap: 15px;">
                <a class="btn btn-sm action-btn cmd" onclick="jeedom.cmd.execute({id: '#prev_id#'});"><i class="fas fa-step-backward"></i></a>
                <a class="btn btn-sm action-btn cmd play-pause-btn" onclick="jeedom.cmd.execute({id: '#play_pause_id#'});" style="width: 45px; height: 45px; border-radius: 50%; background: #fff; color: #2b2b2b; display: flex; justify-content: center; align-items: center;">
                    <i class="fas fa-play" style="font-size: 18px; margin-left: 2px;"></i>
                </a>
                <a class="btn btn-sm action-btn cmd" onclick="jeedom.cmd.execute({id: '#stop_id#'});"><i class="fas fa-stop"></i></a>
                <a class="btn btn-sm action-btn cmd" onclick="jeedom.cmd.execute({id: '#next_id#'});"><i class="fas fa-step-forward"></i></a>
            </div>
            <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-heart heart-btn toggle-shortcuts-btn" title="Mes favoris"></i>
                <img class="logo-jellyfin-img" src="plugins/jellyfin/core/img/logo_jellyfin.png" style="height:30px;">
            </div>
        </div>
    </div>

    <script>
        function _wt(str) {
            return (typeof jeedom !== 'undefined' && jeedom.ui && jeedom.ui.translate) ? jeedom.ui.translate(str) : str;
        }

        var lastSeekTime_#id# = 0;
        var currentMediaId_#id# = null;

        // -- Traductions et Initialisation --
        $('.eqLogic[data-eqLogic_id=#id#] .fav-text-label').text(_wt('Favori'));
        $('.eqLogic[data-eqLogic_id=#id#] .txt-mes-favoris').text(_wt('Mes Favoris'));
        
        var noFavHtml = '<strong>' + _wt('Aucun favori.') + '</strong><br>' + 
                        '<span style="color:#888; font-size:0.9em;">' + _wt('Ou serveur Jellyfin hors ligne') + '</span>';
        $('.eqLogic[data-eqLogic_id=#id#] .txt-aucun-favori').html(noFavHtml);

        $('.eqLogic[data-eqLogic_id=#id#] .add-current-fav-btn').attr('title', _wt('Ajouter ce média aux favoris'));
        $('.eqLogic[data-eqLogic_id=#id#] .heart-btn').attr('title', _wt('Mes favoris'));

        function timeToSeconds_#id#(str) {
            if (!str || str.indexOf('--') !== -1) return 0; 
            str = String(str).replace(/<[^>]*>?/gm, '').trim(); 
            var p = str.split(':'), s = 0, m = 1;
            while (p.length > 0) { s += m * parseInt(p.pop(), 10); m *= 60; }
            return isNaN(s) ? 0 : s; 
        }

        function secondsToTime_#id#(sec_num) {
            var hours = Math.floor(sec_num / 3600), minutes = Math.floor((sec_num - (hours * 3600)) / 60), seconds = Math.floor(sec_num - (hours * 3600) - (minutes * 60));
            return (hours < 10 ? "0"+hours : hours) + ':' + (minutes < 10 ? "0"+minutes : minutes) + ':' + (seconds < 10 ? "0"+seconds : seconds);
        }

        // --- GESTION DE LA BARRE DE PROGRESSION ---
        var $progressArea_#id# = $('.eqLogic[data-eqLogic_id=#id#] .progress-area');
        $progressArea_#id#.off('mousemove mouseleave click');

        $progressArea_#id#.on('mousemove', function(e) {
            var totalStr = $('.eqLogic[data-eqLogic_id=#id#] .time-total').text();
            var totalSec = timeToSeconds_#id#(totalStr);
            if (totalSec <= 0) return;
            var parentOffset = $(this).offset(); 
            var relX = e.pageX - parentOffset.left;
            var pct = relX / $(this).width();
            if (pct < 0) pct = 0; if (pct > 1) pct = 1;
            var seekTimeStr = secondsToTime_#id#(Math.floor(pct * totalSec));
            $(this).find('.seek-tooltip').text(seekTimeStr).css('left', relX + 'px').css('opacity', 1);
            $(this).find('.progress-handle').css('opacity', 1);
        });

        $progressArea_#id#.on('mouseleave', function() {
            $(this).find('.seek-tooltip').css('opacity', 0);
            $(this).find('.progress-handle').css('opacity', 0);
        });

        $progressArea_#id#.on('click', function(e) {
            var totalStr = $('.eqLogic[data-eqLogic_id=#id#] .time-total').text();
            var totalSec = timeToSeconds_#id#(totalStr);
            if (totalSec <= 0) return;
            var relX = e.pageX - $(this).offset().left;
            var pct = relX / $(this).width();
            if (pct < 0) pct = 0; if (pct > 1) pct = 1;
            var seekTimeSec = Math.floor(pct * totalSec);
            var cmdId = '#set_position_id#';
            if (cmdId != '' && cmdId.indexOf('set_position_id') === -1) {
                lastSeekTime_#id# = Date.now();
                jeedom.cmd.execute({ id: cmdId, value: { slider: seekTimeSec } });
                $('.eqLogic[data-eqLogic_id=#id#] .progress-bar').css('width', (pct * 100) + '%');
                $('.eqLogic[data-eqLogic_id=#id#] .time-current').text(secondsToTime_#id#(seekTimeSec));
            }
        });

        function refreshProgressBar_#id#() {
            var currentSec = timeToSeconds_#id#($('.eqLogic[data-eqLogic_id=#id#] .time-current').text());
            var totalSec = timeToSeconds_#id#($('.eqLogic[data-eqLogic_id=#id#] .time-total').text());
            var $area = $('.eqLogic[data-eqLogic_id=#id#] .progress-area');

            if (totalSec > 0) {
                var pct = (currentSec / totalSec) * 100;
                $('.eqLogic[data-eqLogic_id=#id#] .progress-bar').css('width', pct + '%');
                $('.eqLogic[data-eqLogic_id=#id#] .time-remaining').text("-" + secondsToTime_#id#(Math.max(0, totalSec - currentSec)));
                $area.css('cursor', 'pointer'); // Actif
            } else {
                $('.eqLogic[data-eqLogic_id=#id#] .progress-bar').css('width', '0%');
                $area.css('cursor', 'default'); // Inactif (pas de main)
            }
        }

        function refreshStatus_#id#() {
            var status = $('.eqLogic[data-eqLogic_id=#id#] .widget-status').text().trim().toLowerCase();
            var icon = $('.eqLogic[data-eqLogic_id=#id#] .play-pause-btn i');
            if (status.includes('playing') || status.includes('lecture')) {
                icon.attr('class', 'fas fa-pause');
                icon.css('margin-left', '0'); 
            } else {
                icon.attr('class', 'fas fa-play');
                icon.css('margin-left', '2px');
            }
        }

        function refreshCover_#id#(htmlContent) {
            var src = '';
            var foundId = null;
            if (htmlContent) {
                 var matchId = htmlContent.match(/data-media-id=["']?([^"'\s>]+)/);
                 if (matchId) foundId = matchId[1];
            }
            if (foundId) currentMediaId_#id# = foundId;

            if (htmlContent && htmlContent.includes('src=')) {
                var match = htmlContent.match(/src=["']([^"']+)["']/);
                if (match) src = match[1];
            } else if (htmlContent && htmlContent.startsWith('http')) {
                src = htmlContent;
            }

            var widget = $('.eqLogic[data-eqLogic_id=#id#]');
            if (src) {
                widget.find('.cover-img').attr('src', src).show();
                widget.find('.no-cover-icon').hide();
                widget.find('.background-blur').css('background-image', 'url(' + src + ')');
                if (currentMediaId_#id#) widget.find('.add-current-fav-btn').css('display', 'flex');
            } else {
                widget.find('.cover-img').hide();
                widget.find('.no-cover-icon').show();
                widget.find('.background-blur').css('background-image', 'none');
                widget.find('.add-current-fav-btn').hide();
                currentMediaId_#id# = null;
            }
        }

        var updateJellyfinWidget_#id# = function(_options) {
            if (_options.cmd_id == '#position_id#' && Date.now() - lastSeekTime_#id# < 4000) return;
            var widget = $('.eqLogic[data-eqLogic_id=#id#]');
            var cmd = widget.find('.cmd[data-cmd_id="' + _options.cmd_id + '"]');
            cmd.html(_options.display_value);
            if (_options.cmd_id == '#position_id#' || _options.cmd_id == '#duration_id#') refreshProgressBar_#id#();
            if (_options.cmd_id == '#cover_id#') refreshCover_#id#(_options.display_value);
            if (_options.cmd_id == '#status_id#') refreshStatus_#id#();
        }

        if ('#position_id#' != '') jeedom.cmd.update['#position_id#'] = updateJellyfinWidget_#id#;
        if ('#duration_id#' != '') jeedom.cmd.update['#duration_id#'] = updateJellyfinWidget_#id#;
        if ('#status_id#'   != '') jeedom.cmd.update['#status_id#']   = updateJellyfinWidget_#id#;
        if ('#cover_id#'    != '') jeedom.cmd.update['#cover_id#']    = updateJellyfinWidget_#id#;

        if('#cover#' != '') refreshCover_#id#('#cover#');
        refreshStatus_#id#();
        refreshProgressBar_#id#();

        $('.eqLogic[data-eqLogic_id=#id#] .toggle-shortcuts-btn').on('click', function() {
            var panel = $('.eqLogic[data-eqLogic_id=#id#] .view-shortcuts');
            panel.css('left', panel.css('left') === '0px' ? '100%' : '0px');
        });
        $('.eqLogic[data-eqLogic_id=#id#] .close-shortcuts-btn').on('click', function() {
            $('.eqLogic[data-eqLogic_id=#id#] .view-shortcuts').css('left', '100%');
        });
        
        if ($('.eqLogic[data-eqLogic_id=#id#] .shortcuts-grid').children().length == 0) {
            $('.eqLogic[data-eqLogic_id=#id#] .no-shortcuts').css('display', 'flex');
        } else {
             $('.eqLogic[data-eqLogic_id=#id#] .no-shortcuts').hide();
        }

        $('.eqLogic[data-eqLogic_id=#id#] .add-current-fav-btn').on('click', function() {
            if (!currentMediaId_#id#) { alert(_wt("Impossible de récupérer l'ID du média.")); return; }
            var btn = $(this);
            var title = $('.eqLogic[data-eqLogic_id=#id#] .widget-title').text();
            btn.find('i').attr('class', 'fas fa-spinner fa-spin');
            $.ajax({
                type: 'POST',
                url: 'plugins/jellyfin/core/ajax/jellyfin.ajax.php',
                data: { action: 'create_command', id: '#id#', mediaId: currentMediaId_#id#, name: title },
                dataType: 'json',
                success: function (data) {
                    btn.find('i').attr('class', 'fas fa-heart');
                    if (data.state == 'ok') {
                        btn.css('color', '#1DB954');
                        var originalText = btn.find('.fav-text-label').text();
                        btn.find('.fav-text-label').text('OK !');
                        setTimeout(function(){ btn.css('color', '#fff'); btn.find('.fav-text-label').text(originalText); }, 2000);
                        $('.eqLogic[data-eqLogic_id=#id#] .no-shortcuts').hide();
                    } else {
                        btn.css('color', '#f39c12');
                        setTimeout(function(){ btn.css('color', '#fff'); }, 2000);
                    }
                }
            });
        });
        
        $('.eqLogic[data-eqLogic_id=#id#] .delete-shortcut-btn').off('click').on('click', function(e) {
            e.stopPropagation();
            var btn = $(this);
            var cmdId = btn.data('cmd_id');
            var parentCard = btn.closest('.shortcut-item');
            
            var mediaName = parentCard.data('medianame') || parentCard.attr('title') || _wt("ce favori");
            var msg = _wt("Voulez-vous supprimer le favori") + " : <br><b>" + mediaName + "</b> ?";

            bootbox.confirm(msg, function(result) {
                if (result) {
                    $.ajax({
                        type: 'POST',
                        url: 'plugins/jellyfin/core/ajax/jellyfin.ajax.php',
                        data: { action: 'remove_command', cmdId: cmdId },
                        dataType: 'json',
                        success: function (data) {
                            if (data.state == 'ok') {
                                parentCard.fadeOut(300, function(){ 
                                    $(this).remove(); 
                                    var remainingItems = $('.eqLogic[data-eqLogic_id=#id#] .shortcuts-grid .shortcut-item').length;
                                    if (remainingItems === 0) $('.eqLogic[data-eqLogic_id=#id#] .no-shortcuts').css('display', 'flex').hide().fadeIn(200);
                                });
                            }
                        }
                    });
                }
            });
        });

        $('.eqLogic[data-eqLogic_id=#id#] .logo-jellyfin-img, .eqLogic[data-eqLogic_id=#id#] .open-lib-trigger').on('click', function() {
            if (typeof JellyfinBrowser !== 'undefined') JellyfinBrowser.open('#id#', '#name_display#');
        });
    </script>
    <style>
        .jellyfinWidget .action-btn { color: #ccc; transition: all 0.2s; cursor: pointer; }
        .jellyfinWidget .action-btn:hover { color: #1DB954; transform: scale(1.1); }
        .jellyfinWidget .add-current-fav-btn:hover { background: rgba(255,255,255,0.2) !important; transform: scale(1.05); color: #ff4757 !important; }
        
        /* GLOW EFFECTS */
        .heart-btn { color: #666; cursor: pointer; transition: all 0.2s; }
        .heart-btn:hover { color: #ff4757; transform: scale(1.2); filter: drop-shadow(0 0 8px rgba(255, 71, 87, 0.8)); }
        
        .logo-jellyfin-img { cursor: pointer; opacity: 0.6; transition: 0.2s; }
        .logo-jellyfin-img:hover { opacity: 1; transform: scale(1.1); filter: drop-shadow(0 0 8px rgba(156, 39, 176, 0.8)); }
        
        .open-lib-trigger:hover { color: #ff4757 !important; transform: scale(1.2); filter: drop-shadow(0 0 8px rgba(255, 71, 87, 0.8)); }

        .jellyfinWidget .widget-name a:hover { text-decoration: none !important; color: #1DB954 !important; text-shadow: 0 0 8px rgba(29, 185, 84, 0.6); }

        .shortcuts-grid { display: flex; flex-wrap: wrap; gap: 5px; }
        .shortcut-item { width: 50px; height: 75px; background: #333; border-radius: 4px; overflow: hidden; position: relative; }
        .shortcut-item:hover { transform: scale(1.1); z-index: 10; box-shadow: 0 4px 12px rgba(0,0,0,0.8); border: 1px solid #1DB954; }
        .shortcut-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
        
        .delete-shortcut-btn { position: absolute; top: 2px; right: 2px; color: #ff4757; background: rgba(0,0,0,0.7); border-radius: 50%; font-size: 14px; display: none; z-index: 20; transition: all 0.2s; cursor: pointer; }
        .delete-shortcut-btn:hover { transform: scale(1.6); color: red; background: black; }
        .shortcut-item:hover .delete-shortcut-btn { display: block; }
        
        .cursor { cursor: pointer; }
    </style>
</div>