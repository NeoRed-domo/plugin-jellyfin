<div class="eqLogic eqLogic-widget jellyfinWidget" style="width: 350px; border: 1px solid #widget_border_color#; border-radius:#border-radius#; background-color: #202020; color: #fff; overflow: hidden; position: relative; min-height: 250px; display: flex; flex-direction: column;" data-eqLogic_id="#id#" data-eqLogic_uid="#uid#" data-version="#version#">

    <!-- PARTIE HAUTE : COVER + INFOS -->
    <div style="position: relative; height: 160px; overflow: hidden; flex-shrink: 0;">
        <!-- FOND FLOUTÉ -->
        <div class="background-blur" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; opacity: 0.5; background-size: cover; background-position: center; transition: background-image 0.5s ease; filter: blur(8px);"></div>
        <!-- FILTRE SOMBRE -->
        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 1;"></div>

        <!-- TITRE DE L'EQUIPEMENT -->
        <div class="widget-name" style="position: absolute; top: 0; left: 0; width: 100%; padding: 5px; text-align: center; z-index: 10; text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">
            <a href="#eqLink#" style="color: #fff; text-decoration: none; font-weight: bold; font-size: 1.1em; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: color 0.2s;">
                #name_display#
            </a>
        </div>

        <!-- CONTENU -->
        <div style="position: relative; z-index: 2; padding: 15px; padding-top: 35px; display: flex; align-items: center; height: 100%; box-sizing: border-box;">
            <!-- COVER -->
            <div class="album-cover" style="width: 100px; height: 100px; flex-shrink: 0; border-radius: 6px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.6); background-color: #333; display: flex; align-items: center; justify-content: center;">
                <img class="cover-img" src="" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                <i class="fas fa-music no-cover-icon" style="font-size: 40px; color: #555;"></i>
            </div>

            <!-- INFOS -->
            <div style="flex-grow: 1; margin-left: 15px; overflow: hidden; display: flex; flex-direction: column; justify-content: center;">
                <!-- TITRE (Modifié pour 2 lignes max) -->
                <span class="cmd cmd-widget widget-title" data-cmd_id="#title_id#" style="font-weight: bold; font-size: 16px; color: #fff; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; margin-bottom: 5px; text-shadow: 0 1px 3px rgba(0,0,0,0.8); line-height: 1.2;">#title#</span>
                
                <span class="cmd cmd-widget widget-status" data-cmd_id="#status_id#" style="font-size: 12px; color: #ddd; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 1px 2px rgba(0,0,0,0.8);">#status#</span>
                <span class="cmd cmd-widget widget-mediatype" data-cmd_id="#media_type_id#" style="font-size: 10px; color: #ccc; margin-top: 2px; text-shadow: 0 1px 2px rgba(0,0,0,0.8);">#media_type#</span>
            </div>
        </div>
    </div>

    <!-- PARTIE BASSE : CONTROLES -->
    <div style="background-color: #2b2b2b; flex-grow: 1; padding: 15px; display: flex; flex-direction: column; justify-content: space-between; border-top: 1px solid #333;">

        <!-- BARRE DE PROGRESSION & SEEK -->
        <div style="margin-bottom: 15px;">
            <!-- LIGNE DU HAUT : Actuel à Gauche / Restant à Droite -->
            <!-- Police harmonisée à 11px pour tous les éléments -->
            <div style="display: flex; justify-content: space-between; font-size: 11px; color: #aaa; margin-bottom: 5px; font-family: monospace;">
                <span class="cmd cmd-widget time-current" data-cmd_id="#position_id#" style="font-size: 11px;">#position#</span>
                <!-- Temps restant (Calculé en JS) -->
                <span class="time-remaining" style="font-size: 11px;">--:--</span>
            </div>

            <!-- Zone interactive de la barre -->
            <div class="progress-area" style="width: 100%; height: 12px; display: flex; align-items: center; cursor: pointer; position: relative; z-index: 5;">
                <!-- Tooltip (Info-bulle temps) -->
                <div class="seek-tooltip" style="position: absolute; top: -25px; background: #333; color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; pointer-events: none; opacity: 0; transition: opacity 0.1s; transform: translateX(-50%); white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.5);">00:00:00</div>

                <!-- La barre visuelle -->
                <div style="width: 100%; height: 4px; background-color: #444; border-radius: 2px; overflow: visible; pointer-events: none;">
                    <div class="progress-bar" style="width: 0%; height: 100%; background-color: #1DB954; border-radius: 2px; position: relative; transition: width 0.1s linear;">
                         <!-- Petit point au bout de la barre -->
                         <div style="position: absolute; right: -4px; top: -3px; width: 10px; height: 10px; background: #fff; border-radius: 50%; opacity: 0; transition: opacity 0.2s;" class="progress-handle"></div>
                    </div>
                </div>
            </div>

            <!-- LIGNE DU BAS : Total à Droite (sous le restant) -->
            <!-- Harmonisé à 11px + GRAS -->
            <div style="display: flex; justify-content: flex-end; font-size: 11px; color: #aaa; margin-top: 2px; font-family: monospace;">
                <span class="cmd cmd-widget time-total" data-cmd_id="#duration_id#" style="font-weight: bold; font-size: 11px;">#duration#</span>
            </div>
        </div>

        <!-- CONTROLES -->
        <div style="display: flex; justify-content: center; align-items: center; gap: 20px; z-index: 6;">
            <a class="btn btn-sm action-btn cmd" onclick="jeedom.cmd.execute({id: '#prev_id#'});"><i class="fas fa-step-backward"></i></a>

            <a class="btn btn-sm action-btn cmd play-pause-btn" onclick="jeedom.cmd.execute({id: '#play_pause_id#'});" 
               style="width: 50px; height: 50px; border-radius: 50%; background: #fff; color: #2b2b2b; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.5); padding: 0;">
                <i class="fas fa-play" style="font-size: 20px; margin-left: 3px;"></i>
            </a>

            <a class="btn btn-sm action-btn cmd" onclick="jeedom.cmd.execute({id: '#stop_id#'});"><i class="fas fa-stop"></i></a>

            <a class="btn btn-sm action-btn cmd" onclick="jeedom.cmd.execute({id: '#next_id#'});"><i class="fas fa-step-forward"></i></a>
        </div>
    </div>

    <!-- SCRIPT JS -->
    <script>
        // VARIABLE DE VERROUILLAGE (Timestamp du dernier clic)
        var lastSeekTime_#id# = 0;

        // --- 1. UTILITAIRES ---

        function timeToSeconds_#id#(str) {
            if (!str) return 0;
            // Nettoyage HTML et espaces
            str = String(str).replace(/<[^>]*>?/gm, '').trim(); 
            // Si le format est déjà négatif (ex: -01:20), on le gère mais ici on attend un format brut
            var p = str.split(':'), s = 0, m = 1;
            while (p.length > 0) {
                s += m * parseInt(p.pop(), 10);
                m *= 60;
            }
            return s;
        }

        function secondsToTime_#id#(sec_num) {
            var hours   = Math.floor(sec_num / 3600);
            var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
            var seconds = Math.floor(sec_num - (hours * 3600) - (minutes * 60));

            if (hours   < 10) {hours   = "0"+hours;}
            if (minutes < 10) {minutes = "0"+minutes;}
            if (seconds < 10) {seconds = "0"+seconds;}
            return hours+':'+minutes+':'+seconds;
        }

        // --- 2. GESTION DU SEEK (SURVOL + CLIC) ---

        var $progressArea_#id# = $('.eqLogic[data-eqLogic_id=#id#] .progress-area');
        $progressArea_#id#.off('mousemove mouseleave click');

        // Mouse Move (Survol)
        $progressArea_#id#.on('mousemove', function(e) {
            var totalStr = $('.eqLogic[data-eqLogic_id=#id#] .time-total').text();
            var totalSec = timeToSeconds_#id#(totalStr);

            if (totalSec <= 0) return;

            var parentOffset = $(this).offset(); 
            var relX = e.pageX - parentOffset.left;
            var width = $(this).width();
            var pct = relX / width;
            if (pct < 0) pct = 0; if (pct > 1) pct = 1;

            var seekTimeSec = Math.floor(pct * totalSec);
            var seekTimeStr = secondsToTime_#id#(seekTimeSec);

            var tooltip = $(this).find('.seek-tooltip');
            tooltip.text(seekTimeStr);
            tooltip.css('left', relX + 'px');
            tooltip.css('opacity', 1);
            $(this).find('.progress-handle').css('opacity', 1);
        });

        // Mouse Leave (Sortie)
        $progressArea_#id#.on('mouseleave', function() {
            $(this).find('.seek-tooltip').css('opacity', 0);
            $(this).find('.progress-handle').css('opacity', 0);
        });

        // Click (Changement de position)
        $progressArea_#id#.on('click', function(e) {
            var totalStr = $('.eqLogic[data-eqLogic_id=#id#] .time-total').text();
            var totalSec = timeToSeconds_#id#(totalStr);

            if (totalSec <= 0) return;

            var parentOffset = $(this).offset(); 
            var relX = e.pageX - parentOffset.left;
            var width = $(this).width();
            var pct = relX / width;

            if (width <= 0) width = 1;
            if (pct < 0) pct = 0;
            if (pct > 1) pct = 1;

            var seekTimeSec = Math.floor(pct * totalSec);
            var cmdId = '#set_position_id#';

            if (cmdId != '' && cmdId.indexOf('set_position_id') === -1) {
                // 1. ACTIVER LE VERROU : On ignore les updates serveur pendant 4 secondes
                lastSeekTime_#id# = Date.now();

                // 2. Envoi à Jeedom
                jeedom.cmd.execute({ 
                    id: cmdId, 
                    value: { slider: seekTimeSec }
                });

                // 3. MISE A JOUR VISUELLE IMMEDIATE (Optimistic UI)
                // On met à jour la barre, le temps actuel et le temps restant
                $('.eqLogic[data-eqLogic_id=#id#] .progress-bar').css('width', (pct * 100) + '%');
                $('.eqLogic[data-eqLogic_id=#id#] .time-current').text(secondsToTime_#id#(seekTimeSec));
                
                // Calcul du restant optimiste
                var remSec = totalSec - seekTimeSec;
                if(remSec < 0) remSec = 0;
                $('.eqLogic[data-eqLogic_id=#id#] .time-remaining').text("-" + secondsToTime_#id#(remSec));

            } else {
                console.error("Jellyfin Widget #id# : ERREUR - ID commande 'set_position' manquant.");
            }
        });

        // --- 3. MISES A JOUR VISUELLES ---

        function refreshProgressBar_#id#() {
            var currentStr = $('.eqLogic[data-eqLogic_id=#id#] .time-current').text();
            var totalStr   = $('.eqLogic[data-eqLogic_id=#id#] .time-total').text();

            var currentSec = timeToSeconds_#id#(currentStr);
            var totalSec   = timeToSeconds_#id#(totalStr);

            // Mise à jour de la barre
            if (totalSec > 0) {
                var pct = (currentSec / totalSec) * 100;
                $('.eqLogic[data-eqLogic_id=#id#] .progress-bar').css('width', pct + '%');
                
                // Calcul et affichage du temps restant
                var remSec = totalSec - currentSec;
                if (remSec < 0) remSec = 0;
                $('.eqLogic[data-eqLogic_id=#id#] .time-remaining').text("-" + secondsToTime_#id#(remSec));
            } else {
                $('.eqLogic[data-eqLogic_id=#id#] .progress-bar').css('width', '0%');
                $('.eqLogic[data-eqLogic_id=#id#] .time-remaining').text("--:--");
            }
        }

        function refreshCover_#id#(htmlContent) {
            var src = '';
            if (htmlContent && htmlContent.indexOf('<img') !== -1) {
                src = $(htmlContent).attr('src');
            } else if (htmlContent && htmlContent.indexOf('http') !== -1) {
                src = htmlContent;
            }

            if (src) {
                $('.eqLogic[data-eqLogic_id=#id#] .cover-img').attr('src', src).show();
                $('.eqLogic[data-eqLogic_id=#id#] .no-cover-icon').hide();
                $('.eqLogic[data-eqLogic_id=#id#] .background-blur').css('background-image', 'url(' + src + ')');
            } else {
                $('.eqLogic[data-eqLogic_id=#id#] .cover-img').hide();
                $('.eqLogic[data-eqLogic_id=#id#] .no-cover-icon').show();
                $('.eqLogic[data-eqLogic_id=#id#] .background-blur').css('background-image', 'none');
            }
        }

        function refreshStatus_#id#() {
            var status = $('.eqLogic[data-eqLogic_id=#id#] .widget-status').text().trim().toLowerCase();
            var icon = $('.eqLogic[data-eqLogic_id=#id#] .play-pause-btn i');
            var bar = $('.eqLogic[data-eqLogic_id=#id#] .progress-bar');

            if (status == 'playing' || status == 'lecture') {
                icon.removeClass('fa-play').addClass('fa-pause');
                icon.css('margin-left', '0');
                bar.css('background-color', '#1DB954');
            } else {
                icon.removeClass('fa-pause').addClass('fa-play');
                icon.css('margin-left', '3px');
                bar.css('background-color', '#888');
            }
        }

        // --- 4. ENGINE JEEDOM ---

        var updateJellyfinWidget_#id# = function(_options) {
            // VERROU DE SÉCURITÉ :
            // Si l'info reçue est la POSITION et qu'on a cliqué il y a moins de 4 secondes,
            // on ignore TOTALEMENT cette mise à jour (pour ne pas écraser le texte optimiste).
            if (_options.cmd_id == '#position_id#') {
                if (Date.now() - lastSeekTime_#id# < 4000) {
                    return; // On arrête tout, on ne touche ni au texte ni à la barre.
                }
            }

            // Mise à jour standard de Jeedom (Texte HTML)
            var cmd = $('.eqLogic[data-eqLogic_id=#id#] .cmd[data-cmd_id="' + _options.cmd_id + '"]');
            cmd.attr('title','Date de valeur : '+_options.valueDate+'<br/>Collecte : '+_options.collectDate+'<br/>Valeur : '+_options.display_value);
            cmd.html(_options.display_value);

            if(_options.display_value != '') cmd.show(); else cmd.hide();

            // Mises à jour graphiques spécifiques
            if (_options.cmd_id == '#position_id#' || _options.cmd_id == '#duration_id#') {
                refreshProgressBar_#id#();
            }
            if (_options.cmd_id == '#status_id#') {
                refreshStatus_#id#();
            }
            if (_options.cmd_id == '#cover_id#') {
                refreshCover_#id#(_options.display_value);
            }
        }

        // Initialisation des updates
        if ('#position_id#' != '') jeedom.cmd.update['#position_id#'] = updateJellyfinWidget_#id#;
        if ('#duration_id#' != '') jeedom.cmd.update['#duration_id#'] = updateJellyfinWidget_#id#;
        if ('#status_id#'   != '') jeedom.cmd.update['#status_id#']   = updateJellyfinWidget_#id#;
        if ('#title_id#'    != '') jeedom.cmd.update['#title_id#']    = updateJellyfinWidget_#id#;
        if ('#media_type_id#' != '') jeedom.cmd.update['#media_type_id#'] = updateJellyfinWidget_#id#;
        if ('#cover_id#'    != '') jeedom.cmd.update['#cover_id#']    = updateJellyfinWidget_#id#;

        // Lancement initial
        if('#cover#' != '') refreshCover_#id#('#cover#');
        refreshStatus_#id#();
        refreshProgressBar_#id#();

    </script>

    <style>
        .jellyfinWidget .action-btn {
            color: #ccc;
            background: transparent;
            border: none;
            font-size: 20px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .jellyfinWidget .action-btn:hover {
            color: #1DB954; 
            transform: scale(1.1);
        }
        .jellyfinWidget .play-pause-btn:hover {
            color: #000 !important;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(255,255,255,0.4);
        }
        /* Style du titre : pas de soulignement, couleur verte au survol + glow */
        .jellyfinWidget .widget-name a:hover {
            text-decoration: none !important;
            color: #1DB954 !important;
            text-shadow: 0 0 5px rgba(29, 185, 84, 0.4);
        }
        .jellyfinWidget .progress-area:hover .progress-bar {
            background-color: #1ed760 !important;
        }
    </style>
</div>